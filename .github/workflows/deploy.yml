name: Deploy Infrastructure to AWS using Terraform

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-north-1
      DOMAIN: mypodsix.online
      EMAIL: okoro.christianpeace@gmail.com
      TF_DIR: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Get ECR login
        id: login-ecr
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          ECR_URL="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com"
          echo "ECR_URL=$ECR_URL" >> $GITHUB_ENV
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URL

      - name: Create ECR if not exists
        run: |
          REPO_NAME="mediplus-app"
          if ! aws ecr describe-repositories --repository-names $REPO_NAME --region $AWS_REGION >/dev/null 2>&1; then
            echo "ECR repository $REPO_NAME does not exist. Creating..."
            aws ecr create-repository --repository-name $REPO_NAME --region $AWS_REGION
          else
            echo "ECR repository $REPO_NAME already exists. Skipping creation."
          fi

      - name: Build and push Docker image
        run: |
          ECR_REPO_URI=$(aws ecr describe-repositories --repository-names mediplus-app --query "repositories[0].repositoryUri" --output text --region $AWS_REGION)
          echo "ECR_REPO_URI=$ECR_REPO_URI" >> $GITHUB_ENV
          docker build -t mediplus-app .
          docker tag mediplus-app:latest $ECR_REPO_URI:latest
          docker push $ECR_REPO_URI:latest

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init

      - name: Terraform Plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        id: apply
        working-directory: ${{ env.TF_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: tfoutput
        working-directory: ${{ env.TF_DIR }}
        run: |
          echo "WEB_IP=$(terraform output -raw web_server_public_ip)" >> $GITHUB_ENV
          echo "PROXY_IP=$(terraform output -raw reverse_proxy_public_ip)" >> $GITHUB_ENV
          #echo "ECR_REPO_URL=$(terraform output -raw ecr_repo_url)" >> $GITHUB_ENV

      - name: Wait for infrastructure to stabilize
        run: |
          echo "Waiting 3 minutes for EC2 instances to finish booting..."
          sleep 180

      - name: Run deploy script on reverse proxy
        run: |
          echo "Copying deploy.sh to reverse proxy..."
          scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa scripts/deploy.sh ubuntu@${PROXY_IP}:/home/ubuntu/
          echo "Running deployment remotely..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${PROXY_IP} \
            "ECR_REPO_URL='${ECR_REPO_URL}' bash /home/ubuntu/deploy.sh"


      
     
